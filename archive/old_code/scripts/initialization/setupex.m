function ex = setupex(frequencies, stim_params, adapt_params)
    % Set up the ex structure with frequency-specific amplitude ranges
    
    % Initialize ex as empty cell array
    ex = {};
    
    for ifreq = 1:length(frequencies)
        % Calculate frequency-specific amplitude range
        maxAmp = stim_params.maxAmplitude(ifreq);
        minAmp = stim_params.minAmplitude;
        freq_possible_amplitudes = maxAmp:-adapt_params.amplitude_step:minAmp;
        
        % Create entries for this frequency's amplitude range
        for iamp = 1:length(freq_possible_amplitudes)
            ex{ifreq, iamp} = struct(...
                'frequency', frequencies(ifreq), ...
                'amplitude', freq_possible_amplitudes(iamp), ...
                'trialnum', [], ...
                'decision', [], ...
                'stimuli_waveforms', {cell(1,0)}, ...
                'stimuli_durations', [], ...
                'stimuli_phasepattern', [], ...
                'stimuli_jitterdur', [], ...
                'hydrophone', {cell(1,0)}, ...
                'electrodes', create_channels_structure(4) ...
            );
        end
    end
end

function channels = create_channels_structure(num_channels)
    % Create the channels structure with consistent organization
    
    channels = struct();
    
    for ich = 1:num_channels
        channel_name = sprintf('ch%d', ich);
        channels.(channel_name) = create_single_channel_template();
    end
end

function channel = create_single_channel_template()
    % Template for a single channel's data structure
    
    channel = struct(...
        'signals', struct(...
            'prestim_sig', {cell(1,0)}, ...
            'stimresp_sig', {cell(1,0)}, ...
            'poststimresp_sig', {cell(1,0)} ...
        ), ...
        'running_stats', struct(...
            'prestim', struct(...
            'runavg', {cell(1,0)}, ...
            'runstd', {cell(1,0)}, ...
            'runsumsq', {cell(1,0)}, ...
            'N', [] ...
        ), ...
        'stimresp', struct(...
            'runavg', {cell(1,0)}, ...
            'runstd', {cell(1,0)}, ...
            'runsumsq', {cell(1,0)}, ...
            'N', [] ...
        ), ...
        'poststimresp', struct(...
            'runavg', {cell(1,0)}, ...
            'runstd', {cell(1,0)}, ...
            'runsumsq', {cell(1,0)}, ...
            'N', [] ...
        ) ...
        ), ...
        'FFTcalcs', struct(...
        'prestim', struct(...
        'FFT', {cell(1,0)}, ...
        'FFT_std', {cell(1,0)}, ...
        'phase', {cell(1,0)}, ...
        'frequencies', {cell(1,0)} ...
        ), ...
        'stimresp', struct(...
        'FFT', {cell(1,0)}, ...
        'FFT_std', {cell(1,0)}, ...
        'phase', {cell(1,0)}, ...
        'frequencies', {cell(1,0)} ...
        ), ...
        'poststimresp', struct(...
        'FFT', {cell(1,0)}, ...
        'FFT_std', {cell(1,0)}, ...
        'phase', {cell(1,0)}, ...
        'frequencies', {cell(1,0)} ...
        ) ...
        ), ...
        'stats_tests', struct(...
        'fft_ttest_verdict', {{}}, ...  % Empty cell array that can expand
        'fft_ttest_pval', {{}}, ...
        'fft_ttest_critval',{{}},...
        'fft_ttest_tstat', {{}}, ...
        'fft_ttest_df', {{}}, ...
        'spectro_response', [], ...
        'spectro_noise', [], ...
        'spectro_pval', [], ...
        'spectro_pval_trend', [] ...
        ) ...
    );
end